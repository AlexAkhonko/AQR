<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Multi QR AR Overlay - Images</title>
    <style>
        body { margin: 0; font-family: sans-serif; background: #111; color: #fff; }
        #wrap { position: relative; max-width: 100vw; max-height: 100vh; overflow: hidden; }
        video {
            width: 100vw;
            height: auto;
            display: block;
        }
        #overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
        }
        .box {
            position: absolute;
            border: 2px solid #0f0;
            box-shadow: 0 0 10px #0f0;
        }
        .image-overlay {
            position: absolute;
            border: 2px solid #0f0;
            box-shadow: 0 0 15px #0f0;
            overflow: hidden;
            /* ТОЧНО по центру QR, без сдвига */
            transform: translate(-50%, -50%);
        }
        .image-overlay img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        #list {
            padding: 8px;
            font-size: 14px;
            background: rgba(0,0,0,0.8);
            max-height: 200px;
            overflow-y: auto;
        }
        #status { font-size: 12px; opacity: 0.7; }
        button {
            margin: 4px;
            padding: 6px 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div id="wrap">
    <video id="video" autoplay playsinline></video>
    <div id="overlay"></div>
</div>

<div id="list">
    <div id="status">Загрузка картинок…</div>
    <div id="results"></div>
    <button id="startBtn">Начать</button>
    <button id="stopBtn" disabled>Стоп</button>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    /**
     * Из контроллера передаём Map<String,String>:
     * qrToImage = { "car456": "/items/1/car.jpg", "home999": "/items/1/home.png", ... }
     * Thymeleaf в режиме th:inline="javascript" корректно сериализует Map в JS-объект. [web:627]
     */
    const qrToImage = /*[[${qrToImage}]]*/ {};
    /*]]>*/
</script>

<script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');

    let stream = null;
    let running = false;
    let detector = null;

    // Кеш картинок: ключ = qrCode, значение = HTMLImageElement
    let images = {};
    const overlayCache = new Map(); // rawValue -> {boxEl, imageDiv, imgEl, lastSeen}
    const OVERLAY_TTL_MS = 1200;     // 500–1200 подбери

    async function preloadImages() {
        statusEl.textContent = 'Предзагрузка картинок…';

        const entries = Object.entries(qrToImage);
        if (entries.length === 0) {
            statusEl.textContent = 'Нет предметов с картинками у текущего пользователя.';
            return;
        }

        for (const [qrCode, url] of entries) {
            try {
                const img = new Image();
                img.src = url;
                await new Promise((resolve) => {
                    img.onload = resolve;
                    img.onerror = () => {
                        console.warn(`Не удалось загрузить ${url}`);
                        resolve();
                    };
                });
                images[qrCode] = img;
            } catch (e) {
                console.error('Ошибка preload:', e);
            }
        }

        statusEl.textContent = `${Object.keys(images).length}/${entries.length} картинок загружено. Жми "Начать".`;
    }

    function getImageForQR(rawValue) {
        const key = (rawValue || '').trim();
        return images[key] || null; // точное совпадение QR -> картинка
    }

    function ensureOverlayFor(value) {
        let o = overlayCache.get(value);
        if (o) return o;

        const boxEl = document.createElement('div');
        boxEl.className = 'box';
        overlay.appendChild(boxEl);

        const imageDiv = document.createElement('div');
        imageDiv.className = 'image-overlay';
        const imgEl = document.createElement('img');
        imageDiv.appendChild(imgEl);
        overlay.appendChild(imageDiv);

        o = { boxEl, imageDiv, imgEl, lastSeen: 0 };
        overlayCache.set(value, o);
        return o;
    }

    function cleanupOverlays(now) {
        for (const [value, o] of overlayCache.entries()) {
            if (now - o.lastSeen > OVERLAY_TTL_MS) {
                o.boxEl.remove();
                o.imageDiv.remove();
                overlayCache.delete(value);
            }
        }
    }


    async function initDetector() {
        // BarcodeDetector.detect() возвращает Promise<Array<DetectedBarcode>>. [web:694]
        if ('BarcodeDetector' in window) {
            try {
                const formats = await BarcodeDetector.getSupportedFormats(); // [web:712]
                if (formats.includes('qr_code')) {
                    detector = new BarcodeDetector({ formats: ['qr_code'] });
                } else {
                    // если вдруг qr_code отсутствует, попробуем всё что есть
                    detector = new BarcodeDetector({ formats });
                }
            } catch (e) {
                console.error('Ошибка инициализации BarcodeDetector:', e);
                detector = null;
            }
        } else {
            detector = null;
        }

        if (!detector) {
            statusEl.textContent = 'BarcodeDetector не поддерживается в этом браузере/окружении.';
            return;
        }

        await preloadImages();
    }

    async function start() {
        if (!detector) {
            alert('BarcodeDetector недоступен.');
            return;
        }

        try {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Камера недоступна: navigator.mediaDevices.getUserMedia отсутствует (нужен HTTPS или настройка браузера).');
                return;
            }

            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }
            });

            video.srcObject = stream;
            running = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            statusEl.textContent = 'Сканирование…';
            requestAnimationFrame(loop);
        } catch (e) {
            console.error(e);
            statusEl.textContent = 'Ошибка камеры: ' + e.message;
        }
    }

    function stop() {
        running = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;

        if (stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }

        video.srcObject = null;
        clearOverlay();
        resultsEl.textContent = '';
        statusEl.textContent = 'Остановлено.';
    }

    function clearOverlay() {
        overlay.innerHTML = '';
    }

    function drawOverlay(barcodes) {
        const rect = video.getBoundingClientRect();
        const scaleX = rect.width / video.videoWidth;
        const scaleY = rect.height / video.videoHeight;

        const now = Date.now();

        barcodes.forEach(code => {
            const bb = code.boundingBox;
            if (!bb) return;

            const rawValue = (code.rawValue || '').trim();
            if (!rawValue) return;

            const o = ensureOverlayFor(rawValue);
            o.lastSeen = now;

            // Рамка
            o.boxEl.style.left = (bb.x * scaleX) + 'px';
            o.boxEl.style.top = (bb.y * scaleY) + 'px';
            o.boxEl.style.width = (bb.width * scaleX) + 'px';
            o.boxEl.style.height = (bb.height * scaleY) + 'px';

            // Картинка
            const imgElement = getImageForQR(rawValue);
            if (imgElement) {
                o.imageDiv.style.width = (bb.width * scaleX) + 'px';
                o.imageDiv.style.height = (bb.height * scaleY) + 'px';

                const centerX = (bb.x + bb.width / 2) * scaleX;
                const centerY = (bb.y + bb.height / 2) * scaleY;
                o.imageDiv.style.left = centerX + 'px';
                o.imageDiv.style.top = centerY + 'px';

                if (o.imgEl.src !== imgElement.src) o.imgEl.src = imgElement.src;
                o.imageDiv.style.display = 'block';
            } else {
                o.imageDiv.style.display = 'none';
            }
        });

        cleanupOverlays(now);
    }


    async function loop() {
        if (!running || video.readyState !== video.HAVE_ENOUGH_DATA) {
            if (running) requestAnimationFrame(loop);
            return;
        }

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        try {
            const barcodes = await detector.detect(canvas); // multi-detect [web:694]
            if (barcodes.length > 0) {
                drawOverlay(barcodes);

                const items = barcodes.map((b, i) => {
                    const imgName = getImageForQR(b.rawValue)?.src.split('/').pop() || 'нет';
                    return `${i + 1}. ${String(b.rawValue).substring(0, 20)}... → ${imgName}`;
                });
                resultsEl.innerHTML = `<strong>Найдено: ${barcodes.length}</strong><br>${items.join('<br>')}`;
                statusEl.textContent = 'Сканирование…';
            } else {
                // ничего не стираем сразу — cleanupOverlays сам уберёт через TTL
                resultsEl.textContent = 'Коды не найдены.';
                cleanupOverlays(Date.now());
            }
        } catch (e) {
            console.error(e);
            // частая ошибка: service unavailable / not supported in current platform
            statusEl.textContent = 'Ошибка детектора: ' + (e && e.message ? e.message : e);
        }

        if (running) requestAnimationFrame(loop);
    }

    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);

    initDetector();
</script>
</body>
</html>
